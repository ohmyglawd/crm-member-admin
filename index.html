<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRM å¾Œå° - æœƒå“¡ç®¡ç†</title>
    <style>
      :root {
        --bg:#f3f6fb;--card:#fff;--text:#0f172a;--soft:#64748b;--line:#dbe3ef;
        --primary:#2563eb;--good:#059669;--warn:#d97706;--bad:#dc2626;
      }
      *{box-sizing:border-box}
      body{margin:0;font-family:Inter,"Noto Sans TC",system-ui,sans-serif;background:var(--bg);color:var(--text)}
      .wrap{max-width:1280px;margin:0 auto;padding:20px}
      h1{margin:0 0 8px;font-size:1.5rem}
      .help{color:var(--soft);font-size:.9rem}
      .tabs{display:flex;gap:8px;margin:10px 0 14px}
      .tab{border:1px solid var(--line);background:#fff;color:#0f172a;padding:8px 12px;border-radius:10px;cursor:pointer}
      .tab.active{background:#2563eb;color:#fff;border-color:#2563eb}
      .view{display:none}.view.active{display:block}

      .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
      .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:14px}
      .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
      .kpi .l{color:var(--soft);font-size:.85rem}.kpi .v{margin-top:6px;font-size:1.3rem;font-weight:800}

      input,select,button,textarea{font:inherit}
      input,select,button{height:38px;border-radius:10px;border:1px solid var(--line);padding:0 10px}
      textarea{border-radius:10px;border:1px solid var(--line);padding:10px;resize:vertical}
      button{background:var(--primary);color:#fff;border:none;cursor:pointer}
      button.secondary{background:#475569}
      button.ghost{background:#fff;color:#0f172a;border:1px solid var(--line)}

      .filters{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto auto;gap:10px;margin-bottom:14px}
      table{width:100%;border-collapse:collapse}
      th,td{text-align:left;padding:10px 8px;border-bottom:1px solid var(--line);font-size:.92rem}
      th{color:var(--soft);font-weight:700}
      tr.member-row:hover{background:#f8fafc}
      .toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--soft)}
      .pager{display:flex;gap:8px;align-items:center}.pager button{width:34px;height:34px;padding:0}
      .tag{display:inline-block;padding:3px 8px;border-radius:999px;font-size:.78rem;font-weight:700}
      .status-active{color:var(--good);font-weight:700}.status-inactive{color:var(--bad);font-weight:700}.status-pending{color:var(--warn);font-weight:700}

      .drawer{position:fixed;top:0;right:-420px;width:400px;height:100vh;background:#fff;border-left:1px solid var(--line);box-shadow:-12px 0 30px rgba(2,6,23,.12);transition:right .2s;padding:16px;overflow:auto;z-index:20}
      .drawer.open{right:0}
      .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
      .field{border:1px solid var(--line);border-radius:10px;padding:10px}.field .k{color:var(--soft);font-size:.8rem}.field .v{margin-top:4px;font-weight:700}

      .modal-mask{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:30}
      .modal-mask.show{display:flex}
      .modal{width:min(760px,92vw);background:#fff;border-radius:12px;border:1px solid var(--line);padding:16px}
      .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

      .level-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto auto;gap:10px}

      /* ç«™å…§ä¿¡ï¼ˆå°é½ŠåŸå‹ï¼šæœå°‹æ¢ + å¤§è¡¨æ ¼ï¼‰ */
      .msg-kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:12px}
      .msg-filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto auto auto;gap:10px;margin-bottom:12px}
      .msg-table-wrap{overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff}
      .msg-table td,.msg-table th{white-space:nowrap;vertical-align:top}
      .msg-title-cell{max-width:220px;white-space:normal}
      .msg-content-cell{max-width:360px;white-space:normal;color:var(--soft)}
      .msg-status-draft{color:#64748b;font-weight:700}
      .msg-status-scheduled{color:#d97706;font-weight:700}
      .msg-status-sent{color:#059669;font-weight:700}
      .msg-status-deleted{color:#dc2626;font-weight:700}
      .inline-actions{display:flex;gap:6px}
      .tiny-btn{height:28px;min-width:28px;padding:0 8px;border-radius:8px}
      .compose{margin-top:12px;border-top:1px dashed var(--line);padding-top:12px;display:grid;gap:8px}
      .compose textarea{min-height:100px}

      @media (max-width:1040px){
        .kpis,.msg-kpis{grid-template-columns:repeat(2,minmax(0,1fr))}
        .filters{grid-template-columns:1fr 1fr}
        .level-grid{grid-template-columns:1fr 1fr}
        .msg-filters{grid-template-columns:1fr 1fr}
        .drawer{width:92vw}
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>CRM å¾Œå° - æœƒå“¡ç®¡ç†</h1>
      <div class="help">æœƒå“¡è³‡æ–™é  + æœƒå“¡ç­‰ç´šè¨­å®šé  + ä»£ç†ç«™å…§ä¿¡ï¼ˆå‡è³‡æ–™ï¼‰</div>

      <div class="tabs">
        <button class="tab active" data-tab="members">æœƒå“¡è³‡æ–™</button>
        <button class="tab" data-tab="levels">æœƒå“¡ç­‰ç´šè¨­å®š</button>
        <button class="tab" data-tab="messages">ä»£ç†ç«™å…§ä¿¡</button>
      </div>

      <section id="view-members" class="view active">
        <section class="kpis" id="kpis"></section>
        <section class="panel">
          <div class="filters">
            <input id="q" placeholder="æœå°‹ï¼šå§“å / Email / é›»è©± / æœƒå“¡ç·¨è™Ÿ" />
            <select id="tier"><option value="">æœƒå“¡ç­‰ç´šï¼ˆå…¨éƒ¨ï¼‰</option></select>
            <select id="status"><option value="">ç‹€æ…‹ï¼ˆå…¨éƒ¨ï¼‰</option><option>Active</option><option>Inactive</option><option>Pending</option></select>
            <select id="channel"><option value="">ä¾†æºæ¸ é“ï¼ˆå…¨éƒ¨ï¼‰</option><option>Ads</option><option>Organic</option><option>Referral</option><option>Event</option></select>
            <select id="sort"><option value="created_desc">è¨»å†Šæ™‚é–“ï¼šæ–°åˆ°èˆŠ</option><option value="created_asc">è¨»å†Šæ™‚é–“ï¼šèˆŠåˆ°æ–°</option><option value="ltv_desc">LTVï¼šé«˜åˆ°ä½</option><option value="points_desc">é»æ•¸ï¼šé«˜åˆ°ä½</option></select>
            <button id="exportCsv" class="ghost">åŒ¯å‡º CSV</button>
            <button id="reset" class="secondary">é‡è¨­</button>
          </div>
          <div style="overflow:auto;">
            <table>
              <thead><tr><th>æœƒå“¡ç·¨è™Ÿ</th><th>å§“å</th><th>Email / é›»è©±</th><th>ç­‰ç´š</th><th>ç‹€æ…‹</th><th>ä¾†æº</th><th>ç¸½æ¶ˆè²»(LTV)</th><th>é»æ•¸</th><th>è¨»å†Šæ—¥</th><th>æœ€å¾Œç™»å…¥</th><th>æ“ä½œ</th></tr></thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="toolbar"><div id="summary"></div><div class="pager"><button id="prev">â€¹</button><span id="pageInfo"></span><button id="next">â€º</button></div></div>
        </section>
      </section>

      <section id="view-levels" class="view">
        <section class="panel" style="margin-bottom:12px;">
          <h3 style="margin:0 0 10px;">æ–°å¢ / ç·¨è¼¯æœƒå“¡ç­‰ç´š</h3>
          <div class="level-grid">
            <input id="lv_name" placeholder="ç­‰ç´šåç¨±ï¼ˆä¾‹ï¼šPlatinumï¼‰" />
            <input id="lv_min_ltv" type="number" placeholder="æœ€ä½ LTV" />
            <input id="lv_min_points" type="number" placeholder="æœ€ä½é»æ•¸" />
            <input id="lv_color" placeholder="æ¨™ç±¤è‰²ï¼ˆä¾‹ï¼š#7c3aedï¼‰" value="#7c3aed" />
            <button id="lv_save">å„²å­˜ç­‰ç´š</button>
            <button id="lv_reset" class="secondary">æ¸…ç©ºè¡¨å–®</button>
          </div>
          <div class="help" style="margin-top:8px;">è¦å‰‡ï¼šLTV + é»æ•¸åŒæ™‚é”æ¨™ï¼Œç³»çµ±ä¾é–€æª»é«˜åˆ°ä½è‡ªå‹•åˆ¤å®šç­‰ç´šã€‚</div>
        </section>
        <section class="panel">
          <h3 style="margin:0 0 10px;">æœƒå“¡ç­‰ç´šæ¸…å–®</h3>
          <table>
            <thead><tr><th>ç­‰ç´š</th><th>æœ€ä½ LTV</th><th>æœ€ä½é»æ•¸</th><th>æ¨™ç±¤è‰²</th><th>ç¬¦åˆæœƒå“¡æ•¸</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="levelRows"></tbody>
          </table>
        </section>
      </section>

      <section id="view-messages" class="view">
        <section class="msg-kpis" id="msgKpis"></section>
        <section class="panel">
          <div class="msg-filters">
            <select id="msgStatusFilter"><option value="">ç«™å…§ä¿¡ç‹€æ…‹ï¼ˆå…¨éƒ¨ï¼‰</option><option value="sent">å·²ç™¼é€</option><option value="scheduled">é ç´„ä¸­</option><option value="draft">è‰ç¨¿</option><option value="deleted">å·²åˆªé™¤</option></select>
            <input id="msgCreator" placeholder="å»ºç«‹è€…" />
            <select id="msgTimeType"><option value="createdAt">å»ºç«‹æ™‚é–“</option><option value="sentAt">ç™¼é€æ™‚é–“</option></select>
            <input id="msgRangeStart" type="datetime-local" />
            <input id="msgRangeEnd" type="datetime-local" />
            <button id="msgSearch">æœå°‹</button>
            <button id="msgReset" class="secondary">é‡ç½®</button>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div class="help">å¯å¤šé¸å¾Œæ‰¹é‡åˆªé™¤ï¼›æ¬„ä½å°é½ŠåŸå‹ï¼šä¸»æ—¨/å…§å®¹/ç‹€æ…‹/å·²ç™¼é€äººæ•¸/å»ºç«‹è€…/ä¿®æ”¹è€…/å»ºç«‹æ™‚é–“/ç™¼é€æ™‚é–“/æ“ä½œ</div>
            <div style="display:flex;gap:8px;">
              <button id="msgCreate">+ æ–°å¢ç«™å…§ä¿¡</button>
              <button id="msgBatchDelete" class="ghost">æ‰¹é‡åˆªé™¤</button>
            </div>
          </div>

          <div class="msg-table-wrap">
            <table class="msg-table">
              <thead>
                <tr>
                  <th><input id="msgCheckAll" type="checkbox" /></th>
                  <th>ç«™å…§ä¿¡ä¸»æ—¨</th>
                  <th>ç«™å…§ä¿¡å…§å®¹</th>
                  <th>ç«™å…§ä¿¡ç‹€æ…‹</th>
                  <th>å·²ç™¼é€äººæ•¸</th>
                  <th>å»ºç«‹è€…</th>
                  <th>ä¿®æ”¹è€…</th>
                  <th>å»ºç«‹æ™‚é–“</th>
                  <th>ç™¼é€æ™‚é–“</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="msgRows"></tbody>
            </table>
          </div>

          <div class="toolbar">
            <div id="msgSummary"></div>
            <div class="pager"><button id="msgPrev">â€¹</button><span id="msgPageInfo"></span><button id="msgNext">â€º</button></div>
          </div>

          <div class="compose">
            <h4 style="margin:0">æ–°å¢ / ç·¨è¼¯ç«™å…§ä¿¡ï¼ˆå‡è³‡æ–™ï¼‰</h4>
            <div class="form-grid">
              <input id="composeSubject" placeholder="ç«™å…§ä¿¡ä¸»æ—¨" />
              <select id="composeStatus"><option value="sent">å·²ç™¼é€</option><option value="scheduled">é ç´„ä¸­</option><option value="draft">è‰ç¨¿</option></select>
              <textarea id="composeBody" placeholder="ç«™å…§ä¿¡å…§å®¹"></textarea>
              <div style="display:grid;gap:8px;">
                <input id="composeCreator" placeholder="å»ºç«‹è€…ï¼ˆä¾‹ï¼šlvd_rjin_wï¼‰" value="lvd_rjin_w" />
                <input id="composeModifier" placeholder="ä¿®æ”¹è€…ï¼ˆä¾‹ï¼šlvd_rjin_wï¼‰" value="lvd_rjin_w" />
                <input id="composeSentCount" type="number" min="0" placeholder="å·²ç™¼é€äººæ•¸" value="0" />
                <input id="composeSendAt" type="datetime-local" />
              </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;">
              <button id="composeClear" class="secondary">æ¸…ç©º</button>
              <button id="composeSend">å„²å­˜ç«™å…§ä¿¡</button>
            </div>
          </div>
        </section>
      </section>
    </div>

    <aside class="drawer" id="drawer">
      <div style="display:flex;justify-content:space-between;align-items:center;"><h3>æœƒå“¡è©³ç´°è³‡æ–™</h3><button id="closeDrawer" class="ghost" style="height:30px;">é—œé–‰</button></div>
      <div id="drawerBody" class="grid2"></div>
      <div style="margin-top:12px;"><button id="drawerEdit">ç·¨è¼¯è³‡æ–™</button></div>
    </aside>

    <div class="modal-mask" id="editMask">
      <div class="modal">
        <h3 style="margin:0 0 12px;">ç·¨è¼¯æœƒå“¡ï¼ˆå‡å¯«å…¥ï¼‰</h3>
        <div class="form-grid">
          <input id="f_name" placeholder="å§“å" /><input id="f_email" placeholder="Email" />
          <input id="f_phone" placeholder="é›»è©±" /><select id="f_status"><option>Active</option><option>Inactive</option><option>Pending</option></select>
          <select id="f_channel"><option>Ads</option><option>Organic</option><option>Referral</option><option>Event</option></select>
          <input id="f_ltv" type="number" placeholder="LTV" /><input id="f_points" type="number" placeholder="é»æ•¸" />
        </div>
        <div class="actions"><button id="cancelEdit" class="secondary">å–æ¶ˆ</button><button id="saveEdit">å„²å­˜</button></div>
      </div>
    </div>

    <script>
      const members = Array.from({ length: 48 }).map((_, i) => {
        const statuses = ["Active", "Inactive", "Pending"];
        const channels = ["Ads", "Organic", "Referral", "Event"];
        const first = ["ç‹", "æ", "é™³", "æ—", "å¼µ", "é»ƒ", "å³", "åŠ‰"][i % 8];
        const last = ["å°å®‰", "ä½³ç©", "å¿—æ˜", "æ€¡å›", "æŸç¿°", "é›…å©·", "å®¶è±ª", "è©©æ¶µ"][i % 8];
        return {
          id: `M${String(10001 + i)}`,
          name: first + last,
          email: `member${i + 1}@demo-crm.com`,
          phone: `09${String(10000000 + i * 97).slice(0, 8)}`,
          status: statuses[i % 3], channel: channels[i % 4],
          ltv: 800 + (i * 137) % 25000, points: (i * 83) % 9800,
          createdAt: new Date(2024, (i * 3) % 12, (i * 7) % 27 + 1),
          lastLoginAt: new Date(2025, (i * 5) % 12, (i * 11) % 27 + 1),
        };
      });

      let levels = [
        { id:'lv1', name:'Gold', minLtv:15000, minPoints:5000, color:'#f59e0b' },
        { id:'lv2', name:'Silver', minLtv:8000, minPoints:2500, color:'#64748b' },
        { id:'lv3', name:'Bronze', minLtv:0, minPoints:0, color:'#b45309' },
      ];

      let messages = Array.from({ length: 36 }).map((_, i) => {
        const to = members[i % members.length];
        const statuses = ['sent','scheduled','draft'];
        const s = statuses[i % 3];
        const subjectList = [
          'å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆä¸»æ—¨æœ€å¤šé¡¯ç¤ºåˆ°ç¬¬äºŒè¡Œ',
          'ä¸»æ—¨é è¦½æ”¯æ´ emoji âœ¨',
          'å›å³é‚Š',
          'ç³»çµ±é€šçŸ¥ï¼šå¸³è™Ÿå®‰å…¨æé†’',
          'æ´»å‹•é€šçŸ¥ï¼šæœ¬æœˆæœƒå“¡å›é¥‹'
        ];
        const bodyList = [
          'å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆç«™å…§ä¿¡å…§å®¹æœ€å¤šé¡¯ç¤ºåˆ°ç¬¬äºŒè¡Œâ€¦â€¦',
          'ç«™å…§ä¿¡å…§å®¹é è¦½æ”¯æ´ emoji èˆ‡å¤šè¡Œæ–‡å­—ã€‚',
          'å¦‚æœæœ‰ emoji ä¹Ÿè¦é¡¯ç¤ºåœ¨é€™è£¡',
          'æ­¤å…§å®¹ç‚ºå‡è³‡æ–™ï¼Œç”¨æ–¼ç«™å…§ä¿¡å¾Œå°æ“ä½œæ¸¬è©¦ã€‚',
          'è«‹è‡³æ´»å‹•é æŸ¥çœ‹å®Œæ•´è¦å‰‡èˆ‡ä½¿ç”¨æœŸé™ã€‚'
        ];
        const createdAt = new Date(2025, (i*2)%12, (i*5)%27 + 1, (i*3)%24, (i*7)%60);
        const sentAt = s === 'sent' ? new Date(createdAt.getTime() + 1000 * 60 * ((i % 12) + 1)) : null;
        return {
          id:`MSG${1000+i}`,
          toId: to.id,
          toName: to.name,
          subject: subjectList[i % subjectList.length],
          body: bodyList[i % bodyList.length],
          status: s,
          sentCount: s === 'sent' ? (5000 + i * 137) : (s === 'scheduled' ? 0 : 0),
          creator: 'lvd_rjin_w',
          modifier: i % 3 === 0 ? '-' : 'lvd_rjin_w',
          createdAt,
          sentAt,
          deleted: false
        };
      });

      const state = { page:1, pageSize:10, selectedId:null, editingLevelId:null, activeMsgId:null, msgPage:1, msgPageSize:8, editingMsgId:null };
      const $ = id => document.getElementById(id);
      const el = {
        tabs:[...document.querySelectorAll('.tab')],
        viewMembers:$('view-members'), viewLevels:$('view-levels'), viewMessages:$('view-messages'),
        q:$('q'), tier:$('tier'), status:$('status'), channel:$('channel'), sort:$('sort'), rows:$('rows'), summary:$('summary'), pageInfo:$('pageInfo'), prev:$('prev'), next:$('next'), reset:$('reset'), exportCsv:$('exportCsv'), kpis:$('kpis'),
        drawer:$('drawer'), closeDrawer:$('closeDrawer'), drawerBody:$('drawerBody'), drawerEdit:$('drawerEdit'),
        editMask:$('editMask'), f_name:$('f_name'), f_email:$('f_email'), f_phone:$('f_phone'), f_status:$('f_status'), f_channel:$('f_channel'), f_ltv:$('f_ltv'), f_points:$('f_points'), cancelEdit:$('cancelEdit'), saveEdit:$('saveEdit'),
        lv_name:$('lv_name'), lv_min_ltv:$('lv_min_ltv'), lv_min_points:$('lv_min_points'), lv_color:$('lv_color'), lv_save:$('lv_save'), lv_reset:$('lv_reset'), levelRows:$('levelRows'),
        msgKpis:$('msgKpis'), msgStatusFilter:$('msgStatusFilter'), msgCreator:$('msgCreator'), msgTimeType:$('msgTimeType'), msgRangeStart:$('msgRangeStart'), msgRangeEnd:$('msgRangeEnd'),
        msgSearch:$('msgSearch'), msgReset:$('msgReset'), msgCreate:$('msgCreate'), msgBatchDelete:$('msgBatchDelete'), msgCheckAll:$('msgCheckAll'), msgRows:$('msgRows'),
        msgSummary:$('msgSummary'), msgPageInfo:$('msgPageInfo'), msgPrev:$('msgPrev'), msgNext:$('msgNext'),
        composeSubject:$('composeSubject'), composeStatus:$('composeStatus'), composeBody:$('composeBody'), composeCreator:$('composeCreator'), composeModifier:$('composeModifier'), composeSentCount:$('composeSentCount'), composeSendAt:$('composeSendAt'), composeClear:$('composeClear'), composeSend:$('composeSend')
      };

      const fmtDate = d => d.toISOString().slice(0,10);
      const fmtDateTime = d => `${d.toISOString().slice(0,10)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const fmtMoney = n => `NT$ ${Number(n).toLocaleString()}`;
      const orderedLevels = () => [...levels].sort((a,b) => (b.minLtv+b.minPoints) - (a.minLtv+a.minPoints));
      const selectedMember = () => members.find(m => m.id === state.selectedId) || null;
      const selectedMessage = () => messages.find(m => m.id === state.activeMsgId) || null; // legacy helper

      function evalTier(m){ return orderedLevels().find(l => m.ltv >= +l.minLtv && m.points >= +l.minPoints) || orderedLevels().at(-1); }
      function tierBadge(l){ return `<span class="tag" style="background:${l.color}22;color:${l.color};border:1px solid ${l.color}55">${l.name}</span>`; }

      function refreshTierFilter(){
        const curr = el.tier.value;
        el.tier.innerHTML = '<option value="">æœƒå“¡ç­‰ç´šï¼ˆå…¨éƒ¨ï¼‰</option>' + orderedLevels().map(l => `<option value="${l.name}">${l.name}</option>`).join('');
        el.tier.value = curr;
      }

      function kpiCards(list){
        const active = list.filter(m => m.status==='Active').length;
        const avg = list.length ? Math.round(list.reduce((a,b)=>a+b.ltv,0)/list.length) : 0;
        const top = orderedLevels()[0]?.name || '-';
        const topCount = list.filter(m => evalTier(m).name === top).length;
        el.kpis.innerHTML = `
          <div class="kpi"><div class="l">æœƒå“¡ç¸½æ•¸</div><div class="v">${list.length}</div></div>
          <div class="kpi"><div class="l">æ´»èºæœƒå“¡</div><div class="v">${active}</div></div>
          <div class="kpi"><div class="l">å¹³å‡ LTV</div><div class="v">${fmtMoney(avg)}</div></div>
          <div class="kpi"><div class="l">${top} æœƒå“¡</div><div class="v">${topCount}</div></div>`;
      }

      function getFilteredMembers(){
        const q = el.q.value.trim().toLowerCase();
        let list = members.filter(m => {
          const tier = evalTier(m).name;
          const hitQ = !q || `${m.id} ${m.name} ${m.email} ${m.phone}`.toLowerCase().includes(q);
          return hitQ && (!el.tier.value || tier===el.tier.value) && (!el.status.value || m.status===el.status.value) && (!el.channel.value || m.channel===el.channel.value);
        });
        const sk = el.sort.value;
        list.sort((a,b)=> sk==='created_desc'?b.createdAt-a.createdAt : sk==='created_asc'?a.createdAt-b.createdAt : sk==='ltv_desc'?b.ltv-a.ltv : b.points-a.points);
        return list;
      }

      function renderDrawer(){
        const m = selectedMember();
        if(!m){ el.drawer.classList.remove('open'); return; }
        const lv = evalTier(m);
        el.drawer.classList.add('open');
        el.drawerBody.innerHTML = `
          <div class="field"><div class="k">æœƒå“¡ç·¨è™Ÿ</div><div class="v">${m.id}</div></div>
          <div class="field"><div class="k">å§“å</div><div class="v">${m.name}</div></div>
          <div class="field"><div class="k">Email</div><div class="v">${m.email}</div></div>
          <div class="field"><div class="k">é›»è©±</div><div class="v">${m.phone}</div></div>
          <div class="field"><div class="k">æœƒå“¡ç­‰ç´š</div><div class="v">${tierBadge(lv)}</div></div>
          <div class="field"><div class="k">ç‹€æ…‹</div><div class="v">${m.status}</div></div>
          <div class="field"><div class="k">ä¾†æº</div><div class="v">${m.channel}</div></div>
          <div class="field"><div class="k">LTV</div><div class="v">${fmtMoney(m.ltv)}</div></div>
          <div class="field"><div class="k">é»æ•¸</div><div class="v">${m.points.toLocaleString()}</div></div>
          <div class="field"><div class="k">è¨»å†Š</div><div class="v">${fmtDate(m.createdAt)}</div></div>
          <div class="field"><div class="k">æœ€å¾Œç™»å…¥</div><div class="v">${fmtDate(m.lastLoginAt)}</div></div>`;
      }

      function renderMembers(){
        refreshTierFilter();
        const list = getFilteredMembers();
        const total = list.length, pages = Math.max(1, Math.ceil(total/state.pageSize));
        if(state.page>pages) state.page = pages;
        const start = (state.page-1)*state.pageSize;
        const pageItems = list.slice(start, start + state.pageSize);
        kpiCards(list);

        el.rows.innerHTML = pageItems.map(m => {
          const lv = evalTier(m);
          return `<tr class="member-row" data-id="${m.id}">
            <td>${m.id}</td><td>${m.name}</td><td>${m.email}<br><span style="color:var(--soft)">${m.phone}</span></td>
            <td>${tierBadge(lv)}</td><td><span class="status-${m.status.toLowerCase()}">${m.status}</span></td><td>${m.channel}</td>
            <td>${fmtMoney(m.ltv)}</td><td>${m.points.toLocaleString()}</td><td>${fmtDate(m.createdAt)}</td><td>${fmtDate(m.lastLoginAt)}</td>
            <td><button class="ghost edit-btn" data-id="${m.id}" style="height:30px;">ç·¨è¼¯</button></td></tr>`;
        }).join('') || `<tr><td colspan="11" style="text-align:center;color:var(--soft)">æŸ¥ç„¡è³‡æ–™</td></tr>`;

        el.summary.textContent = `å…± ${total} ç­†ï¼Œé¡¯ç¤º ${total?start+1:0}-${Math.min(start+state.pageSize,total)} ç­†`;
        el.pageInfo.textContent = `${state.page} / ${pages}`;
        el.prev.disabled = state.page<=1; el.next.disabled = state.page>=pages;
        renderDrawer();
      }

      function renderLevels(){
        const sorted = orderedLevels();
        el.levelRows.innerHTML = sorted.map(l => {
          const count = members.filter(m => evalTier(m).name===l.name).length;
          return `<tr><td>${tierBadge(l)}</td><td>${fmtMoney(l.minLtv)}</td><td>${(+l.minPoints).toLocaleString()}</td><td><span class="tag" style="background:${l.color};color:#fff">${l.color}</span></td><td>${count}</td>
          <td><button class="ghost lv-edit" data-id="${l.id}" style="height:30px;">ç·¨è¼¯</button> <button class="secondary lv-del" data-id="${l.id}" style="height:30px;">åˆªé™¤</button></td></tr>`;
        }).join('');
      }

      function getFilteredMessages(){
        const creator = el.msgCreator.value.trim().toLowerCase();
        const status = el.msgStatusFilter.value;
        const timeField = el.msgTimeType.value || 'createdAt';
        const s = el.msgRangeStart.value ? new Date(el.msgRangeStart.value) : null;
        const e = el.msgRangeEnd.value ? new Date(el.msgRangeEnd.value) : null;

        return messages
          .filter(m => status ? m.status === status : true)
          .filter(m => creator ? (m.creator || '').toLowerCase().includes(creator) : true)
          .filter(m => {
            const t = m[timeField];
            if (!t) return !s && !e;
            return (!s || t >= s) && (!e || t <= e);
          })
          .sort((a,b) => b.createdAt - a.createdAt);
      }

      function renderMsgKpis(){
        const list = messages;
        const sent = list.filter(m => m.status==='sent').length;
        const scheduled = list.filter(m => m.status==='scheduled').length;
        const draft = list.filter(m => m.status==='draft').length;
        const deleted = list.filter(m => m.status==='deleted').length;
        el.msgKpis.innerHTML = `
          <div class="kpi"><div class="l">ç«™å…§ä¿¡ç¸½æ•¸</div><div class="v">${list.length}</div></div>
          <div class="kpi"><div class="l">å·²ç™¼é€</div><div class="v">${sent}</div></div>
          <div class="kpi"><div class="l">é ç´„ä¸­ / è‰ç¨¿</div><div class="v">${scheduled + draft}</div></div>
          <div class="kpi"><div class="l">å·²åˆªé™¤</div><div class="v">${deleted}</div></div>`;
      }

      function statusLabel(s){
        if (s==='sent') return '<span class="msg-status-sent">å·²ç™¼é€</span>';
        if (s==='scheduled') return '<span class="msg-status-scheduled">é ç´„ä¸­</span>';
        if (s==='draft') return '<span class="msg-status-draft">è‰ç¨¿</span>';
        return '<span class="msg-status-deleted">å·²åˆªé™¤</span>';
      }

      function renderMessages(){
        renderMsgKpis();
        const list = getFilteredMessages();
        const total = list.length;
        const pages = Math.max(1, Math.ceil(total / state.msgPageSize));
        if (state.msgPage > pages) state.msgPage = pages;
        const start = (state.msgPage - 1) * state.msgPageSize;
        const pageItems = list.slice(start, start + state.msgPageSize);

        el.msgRows.innerHTML = pageItems.map(m => `
          <tr>
            <td><input type="checkbox" class="msg-check" data-id="${m.id}" /></td>
            <td class="msg-title-cell">${m.subject}</td>
            <td class="msg-content-cell">${m.body}</td>
            <td>${statusLabel(m.status)}</td>
            <td>${m.status === 'sent' ? Number(m.sentCount || 0).toLocaleString() : '-'}</td>
            <td>${m.creator || '-'}</td>
            <td>${m.modifier || '-'}</td>
            <td>${fmtDateTime(m.createdAt)}</td>
            <td>${m.sentAt ? fmtDateTime(m.sentAt) : '-'}</td>
            <td>
              <div class="inline-actions">
                <button class="ghost tiny-btn msg-view" data-id="${m.id}">ğŸ‘</button>
                <button class="ghost tiny-btn msg-edit" data-id="${m.id}">âœ</button>
                <button class="secondary tiny-btn msg-del" data-id="${m.id}">ğŸ—‘</button>
              </div>
            </td>
          </tr>`
        ).join('') || `<tr><td colspan="10" style="text-align:center;color:var(--soft)">æŸ¥ç„¡è³‡æ–™</td></tr>`;

        el.msgSummary.textContent = `å…± ${total} ç­†ï¼Œé¡¯ç¤º ${total ? start + 1 : 0}-${Math.min(start + state.msgPageSize, total)} ç­†`;
        el.msgPageInfo.textContent = `${state.msgPage} / ${pages}`;
        el.msgPrev.disabled = state.msgPage <= 1;
        el.msgNext.disabled = state.msgPage >= pages;
      }

      function openEditMember(id){
        state.selectedId=id; const m=selectedMember(); if(!m) return;
        el.f_name.value=m.name; el.f_email.value=m.email; el.f_phone.value=m.phone;
        el.f_status.value=m.status; el.f_channel.value=m.channel; el.f_ltv.value=m.ltv; el.f_points.value=m.points;
        el.editMask.classList.add('show');
      }

      function exportCsv(){
        const list = getFilteredMembers();
        const headers=['id','name','email','phone','tier','status','channel','ltv','points','createdAt','lastLoginAt'];
        const lines=[headers.join(',')].concat(list.map(m=>{
          const lv=evalTier(m).name;
          return [m.id,m.name,m.email,m.phone,lv,m.status,m.channel,m.ltv,m.points,fmtDate(m.createdAt),fmtDate(m.lastLoginAt)]
            .map(v=>`"${String(v).replaceAll('"','""')}"`).join(',');
        }));
        const a=document.createElement('a');
        a.href=URL.createObjectURL(new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}));
        a.download=`crm-members-${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href);
      }

      function switchTab(name){
        el.tabs.forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
        el.viewMembers.classList.toggle('active',name==='members');
        el.viewLevels.classList.toggle('active',name==='levels');
        el.viewMessages.classList.toggle('active',name==='messages');
      }

      // events
      el.tabs.forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
      [el.q,el.tier,el.status,el.channel,el.sort].forEach(x=>x.addEventListener('input',()=>{state.page=1;renderMembers()}));
      el.prev.addEventListener('click',()=>{if(state.page>1){state.page--;renderMembers()}});
      el.next.addEventListener('click',()=>{state.page++;renderMembers()});
      el.reset.addEventListener('click',()=>{el.q.value='';el.tier.value='';el.status.value='';el.channel.value='';el.sort.value='created_desc';state.page=1;renderMembers()});
      el.exportCsv.addEventListener('click',exportCsv);

      el.closeDrawer.addEventListener('click',()=>{state.selectedId=null;renderDrawer()});
      el.drawerEdit.addEventListener('click',()=>{if(state.selectedId) openEditMember(state.selectedId)});
      el.cancelEdit.addEventListener('click',()=>el.editMask.classList.remove('show'));
      el.saveEdit.addEventListener('click',()=>{
        const m=selectedMember(); if(!m) return;
        m.name=el.f_name.value.trim()||m.name; m.email=el.f_email.value.trim()||m.email; m.phone=el.f_phone.value.trim()||m.phone;
        m.status=el.f_status.value; m.channel=el.f_channel.value; m.ltv=Number(el.f_ltv.value||m.ltv); m.points=Number(el.f_points.value||m.points);
        el.editMask.classList.remove('show'); renderMembers(); renderLevels(); renderMessages();
      });

      document.addEventListener('click',(e)=>{
        const tr=e.target.closest('tr.member-row'); const eb=e.target.closest('.edit-btn');
        if(eb){e.stopPropagation();openEditMember(eb.dataset.id);return}
        if(tr){state.selectedId=tr.dataset.id;renderDrawer()}

        const le=e.target.closest('.lv-edit');
        if(le){const lv=levels.find(x=>x.id===le.dataset.id); if(!lv)return; state.editingLevelId=lv.id; el.lv_name.value=lv.name; el.lv_min_ltv.value=lv.minLtv; el.lv_min_points.value=lv.minPoints; el.lv_color.value=lv.color;}
        const ld=e.target.closest('.lv-del');
        if(ld){if(levels.length<=1) return alert('è‡³å°‘è¦ä¿ç•™ä¸€å€‹æœƒå“¡ç­‰ç´š'); levels=levels.filter(x=>x.id!==ld.dataset.id); renderLevels(); renderMembers();}

        const msgView = e.target.closest('.msg-view');
        if(msgView){
          const m = messages.find(x=>x.id===msgView.dataset.id); if(!m) return;
          alert(`ã€${m.subject}ã€‘\n\n${m.body}`);
        }
        const msgEdit = e.target.closest('.msg-edit');
        if(msgEdit){
          const m = messages.find(x=>x.id===msgEdit.dataset.id); if(!m) return;
          state.editingMsgId = m.id;
          el.composeSubject.value = m.subject;
          el.composeBody.value = m.body;
          el.composeStatus.value = m.status;
          el.composeCreator.value = m.creator || 'lvd_rjin_w';
          el.composeModifier.value = 'lvd_rjin_w';
          el.composeSentCount.value = Number(m.sentCount || 0);
          el.composeSendAt.value = m.sentAt ? new Date(m.sentAt.getTime() - m.sentAt.getTimezoneOffset()*60000).toISOString().slice(0,16) : '';
        }
        const msgDel = e.target.closest('.msg-del');
        if(msgDel){
          const m = messages.find(x=>x.id===msgDel.dataset.id); if(!m) return;
          m.status = 'deleted';
          renderMessages();
        }
      });

      el.lv_save.addEventListener('click',()=>{
        const payload={id:state.editingLevelId||`lv-${Date.now()}`,name:el.lv_name.value.trim(),minLtv:Number(el.lv_min_ltv.value||0),minPoints:Number(el.lv_min_points.value||0),color:el.lv_color.value.trim()||'#7c3aed'};
        if(!payload.name) return alert('è«‹å¡«å¯«ç­‰ç´šåç¨±');
        const idx=levels.findIndex(x=>x.id===payload.id); if(idx>=0) levels[idx]=payload; else levels.push(payload);
        state.editingLevelId=null; el.lv_name.value=''; el.lv_min_ltv.value=''; el.lv_min_points.value=''; el.lv_color.value='#7c3aed';
        renderLevels(); renderMembers();
      });
      el.lv_reset.addEventListener('click',()=>{state.editingLevelId=null; el.lv_name.value=''; el.lv_min_ltv.value=''; el.lv_min_points.value=''; el.lv_color.value='#7c3aed';});

      el.msgSearch.addEventListener('click',()=>{state.msgPage=1;renderMessages();});
      el.msgReset.addEventListener('click',()=>{
        el.msgStatusFilter.value=''; el.msgCreator.value=''; el.msgTimeType.value='createdAt'; el.msgRangeStart.value=''; el.msgRangeEnd.value='';
        state.msgPage=1; renderMessages();
      });
      el.msgPrev.addEventListener('click',()=>{if(state.msgPage>1){state.msgPage--;renderMessages();}});
      el.msgNext.addEventListener('click',()=>{state.msgPage++;renderMessages();});
      el.msgCheckAll.addEventListener('change',()=>{
        document.querySelectorAll('.msg-check').forEach(c=> c.checked = el.msgCheckAll.checked);
      });
      el.msgBatchDelete.addEventListener('click',()=>{
        const ids = [...document.querySelectorAll('.msg-check:checked')].map(x=>x.dataset.id);
        if(!ids.length) return alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„ç«™å…§ä¿¡');
        messages.forEach(m=>{ if(ids.includes(m.id)) m.status='deleted'; });
        el.msgCheckAll.checked = false;
        renderMessages();
      });
      el.msgCreate.addEventListener('click',()=>{
        state.editingMsgId = null;
        el.composeSubject.value=''; el.composeBody.value=''; el.composeStatus.value='sent'; el.composeCreator.value='lvd_rjin_w'; el.composeModifier.value='lvd_rjin_w'; el.composeSentCount.value='0'; el.composeSendAt.value='';
      });

      el.composeClear.addEventListener('click',()=>{
        state.editingMsgId = null;
        el.composeSubject.value=''; el.composeBody.value=''; el.composeStatus.value='sent'; el.composeCreator.value='lvd_rjin_w'; el.composeModifier.value='lvd_rjin_w'; el.composeSentCount.value='0'; el.composeSendAt.value='';
      });

      el.composeSend.addEventListener('click',()=>{
        const subject = el.composeSubject.value.trim();
        const body = el.composeBody.value.trim();
        if(!subject || !body) return alert('è«‹å¡«å¯«ç«™å…§ä¿¡ä¸»æ—¨èˆ‡å…§å®¹');
        const payload = {
          id: state.editingMsgId || `MSG${10000 + Math.floor(Math.random()*90000)}`,
          subject,
          body,
          status: el.composeStatus.value,
          sentCount: Number(el.composeSentCount.value || 0),
          creator: el.composeCreator.value.trim() || 'lvd_rjin_w',
          modifier: el.composeModifier.value.trim() || 'lvd_rjin_w',
          createdAt: new Date(),
          sentAt: el.composeSendAt.value ? new Date(el.composeSendAt.value) : null,
          toId: '-',
          toName: 'å…¨éƒ¨ä»£ç†',
          deleted: false
        };
        const idx = messages.findIndex(x=>x.id===payload.id);
        if(idx>=0){
          messages[idx] = { ...messages[idx], ...payload, createdAt: messages[idx].createdAt };
        } else {
          if(payload.status==='sent' && !payload.sentAt) payload.sentAt = new Date();
          messages.unshift(payload);
        }
        state.editingMsgId = null;
        el.composeSubject.value=''; el.composeBody.value='';
        renderMessages();
      });

      renderLevels(); renderMembers(); renderMessages();
    </script>
  </body>
</html>
